<!DOCTYPE html>
<html lang="en">
<head>
  <title>Smart Dustbin Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #121212; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 20px; }
    
    /* DASHBOARD GRID */
    .dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1200px; margin: 0 auto; }
    
    /* CARDS */
    .card { background: #1e1e1e; padding: 20px; border-radius: 12px; width: 300px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid #333; }
    h2 { margin: 0 0 10px 0; color: #aaa; font-size: 16px; text-transform: uppercase; }
    .value { font-size: 42px; font-weight: bold; }
    
    /* COLORS */
    .safe { color: #4CAF50; }   /* Green */
    .danger { color: #F44336; } /* Red */
    .warn { color: #FFC107; }   /* Yellow */

    /* MAP CONTAINER */
    #map-container { width: 100%; height: 400px; border-radius: 12px; overflow: hidden; margin-top: 20px; border: 1px solid #333; }
    #map { width: 100%; height: 100%; }

    /* CHART CONTAINER */
    .chart-container { width: 100%; background: #1e1e1e; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid #333; }
    
    /* TABLE STYLES */
    .table-container { width: 100%; margin-top: 20px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; background: #1e1e1e; border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; }
    th { background-color: #333; color: #fff; font-weight: bold; }
    tr:hover { background-color: #2c2c2c; }
    .row-time { color: #888; font-size: 0.9em; }

    /* DEBUG LOG */
    #debug-log { color: #555; font-family: monospace; font-size: 12px; margin-top: 30px; }
  </style>
</head>
<body>

  <h1>‚ôªÔ∏è Smart Dustbin Live Monitor</h1>

  <div class="dashboard">
    <div class="card">
      <h2>üóëÔ∏è Fill Level</h2>
      <div id="fill" class="value safe">--%</div>
    </div>

    <div class="card">
      <h2>‚ö†Ô∏è Gas Status</h2>
      <div id="gas-display" class="value safe">--</div>
      <div id="gas-value" style="color: #888; margin-top: 5px; font-size: 14px;">Raw Value: --</div>
    </div>
  </div>

  <div class="dashboard">
    <div id="map-container">
      <div id="map"></div>
    </div>
  </div>

  <div class="dashboard">
    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>
  </div>

  <div class="dashboard">
    <div class="table-container">
      <h2>Recent History</h2>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Fill Level</th>
            <th>Gas Status</th>
            <th>Raw Gas</th>
          </tr>
        </thead>
        <tbody id="history-table">
          </tbody>
      </table>
    </div>
  </div>

  <div id="debug-log">System Initializing...</div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByuxIh3Cp8crhs8NFmIxNN6DtmBpSBUcs&callback=initMap" async defer></script>

  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = "https://dodtdqvntdazpnbmrqwq.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvZHRkcXZudGRhenBuYm1ycXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNDU0ODYsImV4cCI6MjA4MzYyMTQ4Nn0.JPgJyEWQWsAZETxTvm-pjYI7cwTBatbSkTVSU7EWOtw"; 
    
    const GAS_LIMIT = 2000; 

    // Global Variables
    let map, marker;
    let chart;
    const maxDataPoints = 20; // Show last 20 points on graph

    // Debug Logger
    function log(msg) {
      console.log(msg);
      document.getElementById('debug-log').innerText = "System: " + msg;
    }

    // --- 1. INITIALIZE GOOGLE MAP ---
    function initMap() {
      // Default to Malaysia (KL) until data arrives
      const defaultPos = { lat: 3.1412, lng: 101.6865 };
      
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: defaultPos,
        styles: [ // Dark Mode Map Style
          { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
          { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
          { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
        ]
      });
      
      marker = new google.maps.Marker({
        position: defaultPos,
        map: map,
        title: "Smart Dustbin"
      });
    }

    // --- 2. INITIALIZE CHART ---
    function initChart() {
      const ctx = document.getElementById('myChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // Time labels
          datasets: [{
            label: 'Fill Level (%)',
            borderColor: '#4CAF50', // Green
            backgroundColor: 'rgba(76, 175, 80, 0.2)',
            data: [],
            fill: true,
            tension: 0.4
          }, {
            label: 'Gas Level (Raw)',
            borderColor: '#F44336', // Red
            backgroundColor: 'rgba(244, 67, 54, 0)',
            data: [],
            borderDash: [5, 5], // Dashed line
            fill: false,
            tension: 0.4,
            yAxisID: 'y1' // Use right axis for Gas
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { grid: { color: '#333' }, ticks: { color: '#888' } },
            y: { 
              min: 0, max: 100, 
              grid: { color: '#333' }, 
              ticks: { color: '#888' },
              title: { display: true, text: 'Fill %', color: '#aaa' }
            },
            y1: { 
              position: 'right', 
              grid: { drawOnChartArea: false }, 
              ticks: { color: '#F44336' },
              title: { display: true, text: 'Gas Value', color: '#F44336' }
            }
          }
        }
      });
    }

    // --- 3. MAIN APP LOGIC ---
    try {
      const { createClient } = supabase;
      const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      
      // Start Chart
      initChart();

      // --- UPDATE FUNCTION (Handles UI updates) ---
      function updateDashboard(data) {
        if (!data) return;
        
        const timestamp = new Date(data.created_at).toLocaleTimeString();

        // A. Update Cards
        const fillEl = document.getElementById('fill');
        fillEl.innerText = (data.fill_percent || 0) + "%";
        
        // Color Logic for Fill
        if(data.fill_percent > 80) fillEl.className = "value danger";
        else if(data.fill_percent > 50) fillEl.className = "value warn";
        else fillEl.className = "value safe";

        const gasRaw = data.gas_level || 0;
        const gasDisplay = document.getElementById('gas-display');
        document.getElementById('gas-value').innerText = "Raw Value: " + gasRaw;

        if (gasRaw > GAS_LIMIT) {
          gasDisplay.innerText = "HIGH";
          gasDisplay.className = "value danger";
        } else {
          gasDisplay.innerText = "LOW";
          gasDisplay.className = "value safe";
        }

        // B. Update Map (Only if GPS is valid)
        if (data.lat && data.lng && data.lat !== 0 && map) {
          const newPos = { lat: data.lat, lng: data.lng };
          marker.setPosition(newPos);
          map.panTo(newPos);
        }

        // C. Update Chart
        if (chart) {
          // Add new data
          chart.data.labels.push(timestamp);
          chart.data.datasets[0].data.push(data.fill_percent);
          chart.data.datasets[1].data.push(gasRaw);
          
          // Remove old data to keep it clean
          if (chart.data.labels.length > maxDataPoints) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
          }
          chart.update();
        }

        // D. Update Table (Add row to TOP)
        const tableBody = document.getElementById('history-table');
        const row = tableBody.insertRow(0); // Insert at index 0 (Top)
        
        // Add Cells
        row.innerHTML = `
          <td class="row-time">${new Date(data.created_at).toLocaleString()}</td>
          <td><b>${data.fill_percent}%</b></td>
          <td><span style="color: ${gasRaw > GAS_LIMIT ? '#F44336' : '#4CAF50'}">
            ${gasRaw > GAS_LIMIT ? 'HIGH ‚ö†Ô∏è' : 'LOW ‚úÖ'}
          </span></td>
          <td>${gasRaw}</td>
        `;

        // Limit table rows to 20
        if (tableBody.rows.length > 20) {
          tableBody.deleteRow(20);
        }
      }

      // --- LISTEN FOR REALTIME CHANGES ---
      _supabase.channel('readings')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'readings' }, payload => {
          log("New Data Arrived!");
          updateDashboard(payload.new);
        })
        .subscribe();

      // --- LOAD INITIAL HISTORY ---
      async function loadHistory() {
        // Get last 20 rows
        const { data, error } = await _supabase
          .from('readings')
          .select('*')
          .order('created_at', { ascending: false }) // Newest first
          .limit(20);

        if (data) {
          // We need to reverse them for the CHART (Oldest -> Newest)
          // But keep them as is for the TABLE (Newest -> Oldest)
          
          // 1. Fill Table (Already sorted Newest First)
          data.forEach(row => updateDashboard(row)); 

          // 2. Fix Chart Order (The loop above added them Newest->Oldest, which is backwards for a graph)
          // So we clear chart and re-add in reverse
          chart.data.labels = [];
          chart.data.datasets[0].data = [];
          chart.data.datasets[1].data = [];
          
          // Add in reverse (Oldest first) so the line draws correctly left-to-right
          for (let i = data.length - 1; i >= 0; i--) {
            const row = data[i];
            const time = new Date(row.created_at).toLocaleTimeString();
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(row.fill_percent);
            chart.data.datasets[1].data.push(row.gas_level);
          }
          chart.update();
          
          log("History Loaded.");
        }
      }
      
      loadHistory();

    } catch (err) {
      log("Error: " + err.message);
    }
  </script>
</body>
</html>
